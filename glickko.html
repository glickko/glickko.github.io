<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glickko - Realtime Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --text-base: clamp(12px, 3.5vw, 14px);
            --h2-size: clamp(1.0rem, 4vw, 1.25rem);
            --btn-size: clamp(0.75rem, 3vw, 0.9rem);
            --item-padding: clamp(0.5rem, 2vw, 0.75rem);
            --container-padding: clamp(0.75rem, 3vw, 1.5rem);
            --gap-size: clamp(0.75rem, 3vw, 1.5rem);
            --neon-accent: #00ff88;
            --hf-accent: #ffae00;
        }
        html, body { height: 100%; overflow: hidden; }
        body { min-height: 100%; background: #000; font-family: 'Arial', sans-serif; color: #fff; display: flex; flex-direction: column; font-size: var(--text-base); }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://raw.githubusercontent.com/glickko/glickko.github.io/main/background.jpg'); background-size: cover; background-position: center; opacity: 0.3; z-index: -1; }

        header, footer { flex-shrink: 0; z-index: 10; text-align: center; }
        header { padding: 1.5rem 1rem; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; width: 100%; }
        .logo { font-size: clamp(1.3rem, 5vw, 2rem); font-weight: bold; letter-spacing: 3px; color: var(--neon-accent); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .logout-link { font-size: 0.8rem; color: #ff5555; text-decoration: underline; cursor: pointer; display: none; }
        footer { padding: 1rem; background: rgba(10,10,10,0.4); border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; color: #888; text-align: center; }

        main { flex-grow: 1; display: none; gap: var(--gap-size); padding: 0 var(--gap-size) var(--gap-size); overflow: hidden; min-height: 0; }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; transition: opacity 0.5s ease; }
        #login-overlay.hidden { opacity: 0; pointer-events: none; }
        .login-box { background: rgba(20, 20, 25, 0.95); padding: 2rem; border-radius: 12px; border: 1px solid rgba(0,255,136,0.2); text-align: center; width: 90%; max-width: 380px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin: 0.5rem 0; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #fff; text-align: center; font-size: 0.9rem; }
        .login-input:focus { border-color: var(--neon-accent); outline: none; }
        .login-error { color: #ff5555; min-height: 1.2em; font-size: 0.9em; margin-bottom: 10px; }
        
        
        .remember-me-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; color: #aaa; font-size: 0.85rem; }
        .remember-me-container input { accent-color: var(--neon-accent); cursor: pointer; }

        .manager-container { background: rgba(10, 10, 10, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(12px); padding: var(--container-padding); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        #tools-container { flex: 1; } 
        
        .manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-shrink: 0; flex-wrap: wrap; gap: 0.5rem; }
        .manager-header h2 { margin: 0; font-size: var(--h2-size); color: #ddd; }
        
        .admin-btn { padding: 10px 18px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: var(--btn-size); font-weight: bold; background: rgba(255,255,255,0.05); color: #fff; transition: all 0.2s; }
        .admin-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .admin-btn.save { background: rgba(0, 255, 136, 0.15); border-color: var(--neon-accent); color: var(--neon-accent); width: 100%; margin-top: 10px; }
        .admin-btn.save:hover { background: var(--neon-accent); color: #000; box-shadow: 0 0 20px rgba(0,255,136,0.4); }
        .admin-btn.secondary { background: rgba(255, 255, 255, 0.05); }
        .admin-btn.danger { border-color: #ff5555; color: #ff5555; }
        .admin-btn.danger:hover { background: #ff5555; color: #fff; }

        .list-container { flex-grow: 1; overflow-y: auto; padding-right: 10px; min-height: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .list-container::-webkit-scrollbar { width: 6px; }
        .list-container::-webkit-scrollbar-track { background: transparent; }
        .list-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 10px; }
        
        #search-bar { width: 100%; padding: 12px; margin-bottom: 1rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: var(--btn-size); }
        #search-bar:focus { border-color: var(--neon-accent); outline: none; }

        .admin-tool-item { display: flex; align-items: center; justify-content: space-between; padding: var(--item-padding); background-color: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid transparent; transition: all 0.2s; }
        .admin-tool-item:hover { background-color: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
        .admin-tool-item.hf-item { border-left: 3px solid var(--hf-accent); background: rgba(255, 174, 0, 0.05); }
        .admin-tool-item.hf-saved { border-left: 3px solid var(--neon-accent); background: rgba(0, 255, 136, 0.05); }
        .admin-tool-item:not(:last-child) { margin-bottom: 0.5rem; }
        
        .tool-info { flex-grow: 1; min-width: 0; }
        .tool-info .tool-name { font-size: clamp(0.9rem, 2.5vw, 1rem); font-weight: bold; color: #fff; }
        
        .tool-tags-and-actions { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; margin-left: 1rem; }
        .tool-tags { display: flex; gap: 0.25rem; flex-wrap: wrap; justify-content: flex-end; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; background-color: rgba(255,255,255,0.1); color: #aaa; }
        .tag.hf-tag { background-color: rgba(255, 174, 0, 0.2); color: var(--hf-accent); }
        
        .action-btn { padding: 6px; font-size: 1rem; border-radius: 6px; border: none; background: transparent; cursor: pointer; transition: transform 0.2s; opacity: 1; }
        .edit-btn { color: #f1c40f; } 
        .delete-btn { color: #e74c3c; }
        .action-btn:hover { transform: scale(1.2); background: rgba(255,255,255,0.1); }
        .action-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; filter: grayscale(100%); }
        
        .modal { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: #151515; margin: 5% auto; padding: 2rem; border: 1px solid rgba(255,255,255,0.15); width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #aaa; font-size: 0.85rem; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: #fff; font-family: inherit; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--neon-accent); outline: none; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        #modal-tags-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; max-height: 100px; overflow-y: auto; }
        .tag-checkbox-label { display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer; font-size: 0.8rem; user-select: none; }
        .tag-checkbox-label:has(input:checked) { background: rgba(0, 255, 136, 0.2); color: var(--neon-accent); border: 1px solid rgba(0, 255, 136, 0.3); }

        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; padding: 5px 10px; background: #0a0a0a; border-top: 1px solid #222; font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; z-index: 100; }
        #toast-notification { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px); background-color: var(--neon-accent); color: #000; padding: 10px 24px; border-radius: 50px; z-index: 3000; opacity: 0; font-weight: bold; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .loading-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.3); border-radius: 50%; border-top-color: #000; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .config-details { font-size: 0.7rem; color: #555; margin-top: 1rem; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--neon-accent); margin-bottom: 5px;">GLICKKO ADMIN PROTOCOL</h2>
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">Direct GitHub Injection Mode</p>
            <p id="login-error" class="login-error"></p>
            
            <input type="text" id="username-input" class="login-input" placeholder="GitHub Username" value="glickko">
            <input type="text" id="repo-input" class="login-input" placeholder="Repository (glickko.github.io)" value="glickko.github.io">
            <input type="password" id="token-input" class="login-input" placeholder="GitHub Personal Access Token (ghp_...)" autofocus>
            
            <div class="remember-me-container">
                <input type="checkbox" id="remember-me">
                <label for="remember-me">Keep me signed in on this browser</label>
            </div>

            <button id="login-button" class="admin-btn save" style="margin-top: 20px;">INITIALIZE CONNECTION</button>
            
            <div class="config-details">
                <strong>Secured:</strong> Credentials stored locally in browser vault. Obfuscated for privacy.
            </div>
        </div>
    </div>

    <header>
        <div class="logo">ADMIN PANEL</div>
        <div id="logout-btn" class="logout-link">Disconnect / Clear Cache</div>
    </header>

    <main id="main-content">
        <div id="tools-container" class="manager-container">
            <div class="manager-header">
                <h2>Tools Database</h2>
                <button id="add-tool-btn" class="admin-btn"> + NEW TOOL</button>
            </div>
            
            <input type="search" id="search-bar" placeholder="Search archives...">
            
            <div id="tools-list-container" class="list-container">
                <div style="text-align:center; padding: 2rem; color: #666;">Waiting for data...</div>
            </div>

            <button id="push-github-btn" class="admin-btn save">
                <i class="fa-solid fa-cloud-upload"></i> PUSH CHANGES TO LIVE SITE
            </button>
        </div>
    </main>
    
    <div id="status-bar">
        <span id="connection-status">Disconnected</span>
        <span id="last-action">Ready</span>
    </div>
    
    <div id="toast-notification"></div>

    <div id="tool-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px;">Edit Tool</h2>
            <form id="tool-form">
                <input type="hidden" id="tool-id">
                <div class="form-group"><label>Name</label><input type="text" id="tool-name" required></div>
                <div class="form-group"><label>URL</label><input type="text" id="tool-href" required></div>
                <div class="form-group"><label>Description</label><textarea id="tool-desc" rows="3"></textarea></div>
                <div class="form-group"><label>Tags (Select Multiple)</label><div id="modal-tags-container"></div></div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <input type="text" id="new-tag-input" placeholder="Add custom tag..." style="flex:1;">
                    <button type="button" id="add-custom-tag-btn" class="admin-btn">Add</button>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-edit-btn" class="admin-btn secondary">Cancel</button>
                    <button type="submit" class="admin-btn save">Save Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let GITHUB_TOKEN = '';
            let GITHUB_USER = '';
            let GITHUB_REPO = '';
            const FILE_PATH = 'tools.json';
            const HF_USER = 'glickko';
            const HF_REPO = '1412x';
            const STORAGE_KEY = 'ciel_admin_creds';
            
            let toolsData = [];
            let combinedData = [];
            let currentSHA = ''; 
            let globalTags = new Set();

            const loginOverlay = document.getElementById('login-overlay');
            const mainContent = document.getElementById('main-content');
            const toolsListContainer = document.getElementById('tools-list-container');
            const searchBar = document.getElementById('search-bar');
            const toast = document.getElementById('toast-notification');
            const modal = document.getElementById('tool-modal');
            const modalTagsContainer = document.getElementById('modal-tags-container');
            const logoutBtn = document.getElementById('logout-btn');
            
            
            const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
            const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));

            const showToast = (msg, isError = false) => {
                toast.textContent = msg;
                toast.style.backgroundColor = isError ? '#ff5555' : 'var(--neon-accent)';
                toast.style.color = isError ? '#fff' : '#000';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            };

            const updateStatus = (msg) => document.getElementById('last-action').textContent = msg;

            
            
            const saveCredentials = (user, repo, token) => {
                
                const payload = JSON.stringify({ u: user, r: repo, t: token });
                const securePayload = utf8_to_b64(payload); 
                localStorage.setItem(STORAGE_KEY, securePayload);
            };

            const loadCredentials = () => {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        const decoded = JSON.parse(b64_to_utf8(stored));
                        document.getElementById('username-input').value = decoded.u;
                        document.getElementById('repo-input').value = decoded.r;
                        document.getElementById('token-input').value = decoded.t;
                        document.getElementById('remember-me').checked = true;
                        
                        
                        setTimeout(() => {
                            document.getElementById('login-button').click();
                        }, 500); 
                    } catch (e) {
                        console.error("Credential parse error", e);
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            };

            const clearCredentials = () => {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            };

            logoutBtn.addEventListener('click', clearCredentials);

            

            const fetchFromGitHub = async () => {
                updateStatus('Fetching tools.json from GitHub...');
                try {
                    const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}?ref=main&t=${new Date().getTime()}`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                    });

                    if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);

                    const data = await response.json();
                    currentSHA = data.sha; 
                    
                    const content = b64_to_utf8(data.content);
                    const jsonContent = JSON.parse(content);
                    
                    toolsData = jsonContent.tools || [];
                    
                    globalTags.clear();
                    toolsData.forEach(t => (t.tags || []).forEach(tag => globalTags.add(tag)));
                } catch (error) {
                    console.error(error);
                    showToast('Failed to fetch tools.json: ' + error.message, true);
                    toolsData = [];
                }
            };

            const fetchFromHF = async () => {
                updateStatus('Fetching HF Archives...');
                try {
                    const response = await fetch(`https://huggingface.co/api/datasets/${HF_USER}/${HF_REPO}/tree/main`);
                    if (response.ok) {
                        const files = await response.json();
                        return files
                            .filter(file => file.path.match(/\.(rar|zip|7z|exe|apk)$/i))
                            .map(file => ({
                                name: file.path,
                                href: `https://huggingface.co/datasets/${HF_USER}/${HF_REPO}/resolve/main/${file.path}?download=true`,
                                tags: ["HF-ARCHIVE"],
                                description: "Synced from Hugging Face.",
                                isHf: true,
                                isSaved: false 
                            }));
                    }
                } catch (error) {
                    console.error("HF Error", error);
                }
                return [];
            };

            const syncAllData = async () => {
                await fetchFromGitHub();
                const hfRaw = await fetchFromHF();
                
                const toolsMap = new Map(toolsData.map(item => [item.name, item]));
                const hfProcessed = hfRaw.filter(hfItem => !toolsMap.has(hfItem.name));

                combinedData = [...toolsData, ...hfProcessed];
                combinedData.sort((a, b) => a.name.localeCompare(b.name));
                
                renderTools();
                updateStatus('All systems synchronized.');
                showToast('Connected & Loaded!');
            };

            

            const pushToGitHub = async () => {
                const btn = document.getElementById('push-github-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="loading-spinner"></span> PUSHING...`;
                btn.disabled = true;

                try {
                    const now = new Date();
                    const timestamp = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) + 
                                     ' - ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

                    const newContent = {
                        lastUpdated: timestamp,
                        tools: toolsData.sort((a, b) => a.name.localeCompare(b.name))
                    };

                    const jsonString = JSON.stringify(newContent, null, 4);
                    const base64Content = utf8_to_b64(jsonString);

                    const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`;
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update tools.json via Admin Panel (${timestamp})`,
                            content: base64Content,
                            sha: currentSHA 
                        })
                    });

                    if (!response.ok) throw new Error('Commit failed. ' + response.statusText);

                    const result = await response.json();
                    currentSHA = result.content.sha; 
                    
                    showToast('SUCCESS! Site Updating...');
                    alert(`Update Pushed Successfully!\n\nGitHub Pages will take 30-60 seconds to rebuild.\nWait a minute before refreshing the main site.`);
                } catch (error) {
                    showToast('Push Failed: ' + error.message, true);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };

           

            const renderTools = (filter = '') => {
                toolsListContainer.innerHTML = '';
                const term = filter.toLowerCase();
                const filtered = combinedData.filter(t => 
                    t.name.toLowerCase().includes(term) || 
                    (t.tags && t.tags.some(tag => tag.toLowerCase().includes(term)))
                );

                filtered.forEach(tool => {
                    const el = document.createElement('div');
                    const isHfRaw = tool.isHf && !tool.isSaved; 
                    
                    let rowClass = 'admin-tool-item';
                    if (isHfRaw) rowClass += ' hf-item';
                    else if (tool.isSaved) rowClass += ' hf-saved'; 
                    
                    const tagsHtml = (tool.tags || []).map(tag => `<span class="tag ${tag === 'HF-ARCHIVE' ? 'hf-tag' : ''}">${tag}</span>`).join('');
                    
                    el.className = rowClass;
                    el.innerHTML = `
                        <div class="tool-info">
                            <div class="tool-name">${tool.name} ${isHfRaw ? '<span style="font-size:0.7em; color:var(--hf-accent);">[NEW HF]</span>' : ''}</div>
                            <div style="font-size: 0.75rem; color:#666; margin-top:2px;">${tool.href.substring(0, 40)}...</div>
                        </div>
                        <div class="tool-tags-and-actions">
                            <div class="tool-tags">${tagsHtml}</div>
                            <button class="action-btn edit-btn" title="Edit Metadata"><i class="fa-solid fa-pen"></i> ✎</button>
                            <button class="action-btn delete-btn" title="Delete/Reset"><i class="fa-solid fa-trash"></i> ✖</button>
                        </div>
                    `;
                    
                    el.querySelector('.edit-btn').onclick = () => openModal(tool);
                    el.querySelector('.delete-btn').onclick = () => {
                        if(confirm(`Delete "${tool.name}"?\nIf this is an HF file, it will reset to default on next reload.`)) {
                            toolsData = toolsData.filter(t => t.name !== tool.name);
                            combinedData = combinedData.filter(t => t !== tool);
                            renderTools(searchBar.value);
                            showToast('Item removed locally. Push to save.');
                        }
                    };
                    toolsListContainer.appendChild(el);
                });
            };

            const openModal = (tool = null) => {
                const form = document.getElementById('tool-form');
                form.reset();
                document.getElementById('modal-title').textContent = tool ? 'Edit Tool' : 'Add New Tool';
                
                document.getElementById('tool-id').value = tool ? tool.name : "NEW_ENTRY";
                
                if (tool) {
                    document.getElementById('tool-name').value = tool.name;
                    document.getElementById('tool-href').value = tool.href;
                    document.getElementById('tool-desc').value = tool.description || '';
                }

                modalTagsContainer.innerHTML = '';
                const allCurrentTags = new Set([...globalTags, ...(tool?.tags || [])]);
                
                Array.from(allCurrentTags).sort().forEach(tag => {
                    const isChecked = tool && tool.tags && tool.tags.includes(tag);
                    const label = document.createElement('label');
                    label.className = 'tag-checkbox-label';
                    label.innerHTML = `<input type="checkbox" value="${tag}" ${isChecked ? 'checked' : ''}> ${tag}`;
                    modalTagsContainer.appendChild(label);
                });

                modal.style.display = 'block';
            };

            

            document.getElementById('login-button').addEventListener('click', () => {
                const token = document.getElementById('token-input').value.trim();
                const user = document.getElementById('username-input').value.trim();
                const repo = document.getElementById('repo-input').value.trim();
                const remember = document.getElementById('remember-me').checked;

                if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                    document.getElementById('login-error').textContent = "Invalid Token Format. Must start with ghp_ or github_pat_";
                    return;
                }

                GITHUB_TOKEN = token;
                GITHUB_USER = user;
                GITHUB_REPO = repo;

                if (remember) {
                    saveCredentials(user, repo, token);
                }

                loginOverlay.classList.add('hidden');
                mainContent.style.display = 'flex';
                document.querySelector('header').style.display = 'flex'; 
                logoutBtn.style.display = 'block'; 
                document.getElementById('connection-status').textContent = `Connected: ${user}/${repo}`;
                
                syncAllData();
            });

            document.getElementById('push-github-btn').addEventListener('click', pushToGitHub);
            document.getElementById('add-tool-btn').addEventListener('click', () => openModal());
            document.getElementById('cancel-edit-btn').addEventListener('click', () => modal.style.display = 'none');
            
            document.getElementById('tool-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const originalName = document.getElementById('tool-id').value;
                const name = document.getElementById('tool-name').value;
                const href = document.getElementById('tool-href').value;
                const desc = document.getElementById('tool-desc').value;
                const checkedTags = Array.from(document.querySelectorAll('#modal-tags-container input:checked')).map(cb => cb.value);

                const newTool = { name, href, tags: checkedTags, description: desc };

                
                const existingIndex = toolsData.findIndex(t => t.name === (originalName === "NEW_ENTRY" ? name : originalName));
                if (existingIndex > -1) {
                    toolsData[existingIndex] = newTool;
                } else {
                    toolsData.push(newTool);
                }
                
                
                checkedTags.forEach(t => globalTags.add(t));
                const combinedIndex = combinedData.findIndex(t => t.name === (originalName === "NEW_ENTRY" ? name : originalName));
                
                
                const isOriginallyHf = combinedData[combinedIndex]?.isHf;
                
                if (combinedIndex > -1) {
                    combinedData[combinedIndex] = { ...newTool, isSaved: true, isHf: isOriginallyHf };
                } else {
                    combinedData.push({ ...newTool, isSaved: true });
                }
                combinedData.sort((a, b) => a.name.localeCompare(b.name));

                modal.style.display = 'none';
                renderTools(searchBar.value);
                showToast('Metadata saved locally. PUSH to commit.');
            });

            document.getElementById('add-custom-tag-btn').addEventListener('click', () => {
                const input = document.getElementById('new-tag-input');
                const val = input.value.trim().toUpperCase();
                if(val) {
                    globalTags.add(val);
                    const label = document.createElement('label');
                    label.className = 'tag-checkbox-label';
                    label.innerHTML = `<input type="checkbox" value="${val}" checked> ${val}`;
                    modalTagsContainer.appendChild(label);
                    input.value = '';
                }
            });

            searchBar.addEventListener('input', (e) => renderTools(e.target.value));

            
            loadCredentials();
        });
    </script>
</body>
</html>